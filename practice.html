<html>
    <head>
        <title>
            Task viewer
        </title>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="jquery-ui-1.7.2.custom.min.js"></script>
        <script src="http://geek-battle.herokuapp.com/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="jquery.timers.js"></script>
        <script type="text/javascript" src="jquery.flip.js"></script>
        <script type="text/javascript" src="jquery.easing.min.js"></script>
        <script type="text/javascript" src="jquery.lavalamp.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script type="text/javascript">

        function getTask() {
            var level = $(this).data('level');
            var taskType = $('#tasks').val();
            $.getJSON('task', {type: taskType, level: level}, showTask);
        }

        function showTask(task) {
            if (task == null || !playing_game) {
                $('.answers').addClass('hide');
                return;
            }

            // $('#help').html(help);
            $(document.body).removeClass('first');
            var url = 'http://geekbeta-nbeloglazov.dotcloud.com/image?id=' + task.id;
            $('#question').attr('src', url + '&type=question');
            $('.correct').removeClass('correct');
            $('.incorrect').removeClass('incorrect');
            for (var i = 0; i < 4; i++) {
                $('#choice_' + i).attr('src', url + '&type=choice&number=' + i);
                $('#choice_' + i).attr('correct', i === task.correct);
            }
            $('.hide').removeClass('hide');
        }

        function showTasksSelection(tasks) {
            var options = $('#tasks')[0].options;
            $.each(tasks, function() {
                var option = new Option(this.name, this.type);
                options[options.length] = option;
            });
        }

        task_desc = [];
        task_kind = null;
        q_cnt = 3;
        task_level = 1;
        playing_game = false;

        $(function() {
            for (var i = 0; i < 4; i++) {
                $('#choice_' + i).click(function() {
                    $(this).addClass($(this).attr('correct') == "true" ? 'correct' : 'incorrect');
                    socket.emit('get task', $(this).attr('correct') == "true");
                    $('.answers').addClass('hide');
                    $('#images').css('background-color', $(this).attr('correct') == "true" ? '#00ff00' : '#ff0000');
                    $('#images').flip({
                        direction: 'rl',
                        speed: 300,
                        color: '#ffffff'
                    });
                });
            }

            $('#newgame').on('click', function() {
                $('#box-table').css('visibility', 'hidden');
                socket.emit('new game');
            });

            $("#ll2").lavaLamp({
                fx: "backout", 
                speed: 700,
                click: function(event, menuItem) {
                    task_level = menuItem.getAttribute('level');
                }
            });

            $("#ll3").lavaLamp({
                fx: "backout", 
                speed: 700,
                click: function(event, menuItem) {
                    q_cnt = menuItem.getAttribute('qn');
                }
            });
        });


        function make_task_list(tasks) {
            list = "<li><a href='#'>Mixed</a>";
            task_desc = tasks;
            for (var i = 0; i < tasks.length; i++)
                list += "<li task_id='" + i + "''><a href='#'>" + tasks[i].name + "</a></li>";
            $('#ll1').html(list);

            $("#ll1").lavaLamp({
                fx: "backout", 
                speed: 700,
                click: function(event, menuItem) {
                    id = menuItem.getAttribute('task_id');
                    task_kind = id;
                    if (id == null)
                        $('#task_description').html("Use random tasks");
                    else
                        $('#task_description').html(
                            task_desc[id].description.replace(/\n/g, '<br/>').replace(/http:\S+/g, '<a href="$&">$&</a>')
                        );
                    return false;
                }
            });
        }

        </script>

        <script>
            socket = io.connect();
            socket.emit('get tasks description');
            socket.on('tasks description', make_task_list);
            socket.on('show task', showTask);
              
            socket.on('game loaded', function() {
                $('#status').everyTime(1000, 'timer', function(it) {
                    $(this).html('Game starts in ' + (5-it));
                }, 5);
                $('#status').oneTime(5050, 'timer2', function() {
                    socket.emit('get task', false);
                    game_duration = 20;
                    playing_game = true;
                    $(this).html('Game ends in ' + game_duration);
                    $('#status').everyTime(1000, 'gametimer', function(it) {
                        $(this).html('Game ends in ' + (game_duration-it));
                    }, game_duration - 1);
                    $('#status').oneTime(game_duration * 1000, 'endtimer', function() {
                        $('.answers').addClass('hide');
                        $(this).html('<h2>Game over!</h2>');
                        // $('#help').html('');
                        socket.emit('game over');
                        playing_game = false;
                    });
                });
            });

            socket.on('results', function(answers, players) {
                $('#box-table').css('visibility', 'visible');
                header = '<th>Nickname</th><th>Score</th><th>Solved</th><th>Answers</th>'
                table = '';
                list = [];
                for (var pl in players)
                    list.push({score: players[pl].score, nick: pl});
                list.sort(function(a, b) {return b.score - a.score});
                for (var i in list) {
                    pl = list[i].nick;
                    if (players[pl].score == null) return;
                    img = '';
                    $.each(answers[pl], function(index, value) { 
                        if (value) img += '<img src="Box_Green.png">';
                        else img += '<img src="Box_Red.png">';
                    });
                    rclass = "other"
                    if (i == 0) rclass = "gold";
                    if (i == 1)
                        if (list[1].score != list[0].score) rclass = "silver";
                        else rclass = "gold";

                    if (i == 2) {
                        e01 = list[1].score == list[0].score;
                        e12 = list[2].score == list[1].score;
                        if (e01 && e12) rclass = "gold";
                        if (!e01 && e12) rclass = "silver";
                        if (!e12) rclass = "bronze";
                    }

                    row = '<tr class="' + rclass + '">' + '<td>' + pl + '</td><td>' +
                        players[pl].score + '</td><td>' +
                        players[pl].correct + ' of ' + (players[pl].next_task-1) + '</td><td>' +
                        img + '</td></tr>';

                    table += row;
                }
                $('#box-table').html('<table>' + header + table + '</table>');
            });
        </script>

        <style type="text/css">
        body {
            text-align: center;
            padding-top: 20px;
        }
        .answers {
            padding: 10px;
            border: #FFF 4px solid;
        }
        .answers:hover {
            border: #AAA solid 4px;
        }
        
        .hide {
            display: none;
        }

        .first img {
            display: none;
        }

        .green {
            background-color: #00ff00;
        }
        </style>
    </head>

    <body class="first">
        <div class="caption">
            Geek Battle
        </div>
        <div id="practice_main">
            <p>Choose task</p>
            <ul class="lavaLampNoImage" id="ll1">
            </ul>
            <p>Choose difficulty</p>
            <ul class="lavaLampNoImage" id="ll2">
                <li level="1"><a href="#">Easy</a></li>
                <li level="2"><a href="#">Medium</a></li>
                <li level="3"><a href="#">Hard</a></li>
            </ul>
            <p>Choose number of questions</p>
            <ul class="lavaLampNoImage" id="ll3">
                <li qn="3"><a href="#">3</a></li>
                <li qn="5"><a href="#">5</a></li>
                <li qn="7"><a href="#">7</a></li>
                <li qn="10"><a href="#">10</a></li>
                <li qn="15"><a href="#">15</a></li>
                <li qn="20"><a href="#">20</a></li>
            </ul>

            <div id="task_description">
            </div>

            <button id="newgame">New game</button>
            <br/>
            <span id="status">Press 'New game' to begin</span>
            <br/>
            <div id="images">
                <img id="question" class="answers"></img>
                <br/>
                <img id="choice_0" class="answers"></img>
                <img id="choice_1" class="answers"></img>
                <br/>
                <img id="choice_2" class="answers"></img>
                <img id="choice_3" class="answers"></img>
                <table id="box-table">
                    <tr><th>Results</th></tr>                            
                </table>
            </div>
        </div>
        Press Ctrl+R to choose a different nickname. Press Ctrl+W to log out.
    </body>
</html>

