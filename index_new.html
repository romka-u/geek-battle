<html>
    <head>
        <title>
            Geek Battle
        </title>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="jquery-ui-1.7.2.custom.min.js"></script>
        <script src="socket.io/socket.io.js"></script>
        <script type="text/javascript" src="jquery.timers.js"></script>
        <script type="text/javascript" src="jquery.flip.js"></script>
        <script src="http://gsgd.co.uk/sandbox/jquery/easing/jquery.easing.1.3.js"></script>
        <script type="text/javascript" src="jquery.lavalamp.js"></script>

        <link rel="stylesheet" type="text/css" href="style.css">

        <script type="text/javascript">

        game_playing = false;
        game_tasks = [];
        my_answers = [];

        function showTask(task) {
            if (task == null || !game_playing) {
                $('.answers').hide();
                return;
            }

            game_tasks.push(task);
            $(document.body).removeClass('first');
            var url = 'http://geekbeta-nbeloglazov.dotcloud.com/image?id=' + task.id;
            $('#question').attr('src', url + '&type=question');
            $('.correct').removeClass('correct');
            $('.incorrect').removeClass('incorrect');
            for (var i = 0; i < 4; i++) {
                $('#choice_' + i).attr('src', url + '&type=choice&number=' + i);
                $('#choice_' + i).attr('correct', i === task.correct);
            }
            $('#images').show();
            $('.answers').show();
        }

        function showTasksSelection(tasks) {
            var options = $('#select-questions')[0].options;
            $.each(tasks, function() {
                var option = new Option(this.name, this.type);
                options[options.length] = option;
            });
        }

        $(function() {
            $('div.tooltip').hide();
            for (var i = 0; i < 4; i++) {
                $('#choice_' + i).click(function() {
                    $(this).addClass($(this).attr('correct') == "true" ? 'correct' : 'incorrect');
                    my_answers.push($(this).attr('id').substr(7));
                    socket.emit('get task', $(this).attr('correct') == "true");
                    $('.answers').hide();
                    $('#images').css('background-color', $(this).attr('correct') == "true" ? '#00ff00' : '#ff0000');
                    $('#images').flip({
                        direction: 'rl',
                        speed: 300,
                        color: '#ffffff'
                    });
                });
            }

            $('#nicknames').on('click', function() {
                if ($('#options').is(':visible'))
                    $('#options').fadeOut();
                else
                    $('#options').show();
            });

            $('#newgame').on('click', function() {
                $('#status').html('Waiting for players...');
                $('#box-table').css('visibility', 'hidden');
                socket.emit('new game');
            });

            $('#set-nickname').submit(function() {
                if ($.trim($('#nick').val()) == "") return false;
                socket.emit('nickname', $('#nick').val());
                $('#splash').slideUp(2000, "easeInExpo");
                $('#main-table').removeClass('hide');
                // showLavaLamps();
                $('#options').hide();
                return false;
            });

            $('#send-message').submit(function() {
                var msg = $.trim($('#message').val());
                if (msg == "") return false;
                message('me', msg);
                socket.emit('user message', msg);
                // $('#sound-message-sent')[0].play();
                clear();
                return false;
            });

            function clear () {
                $('#message').val('').focus();
            }

            function showLavaLamps() {
                $("#ll-level").lavaLamp({
                    fx: "easeOutBack", 
                    speed: 700,
                    click: function(event, menuItem) {
                        task_level = menuItem.getAttribute('level');
                    }
                });

                $("#ll-gametype").lavaLamp({
                    fx: "easeOutBack", 
                    speed: 700,
                    click: function(event, menuItem) {
                        // q_cnt = menuItem.getAttribute('qn');
                    }
                });

                $("#ll-gamelength").lavaLamp({
                    fx: "easeOutBack", 
                    speed: 700,
                    click: function(event, menuItem) {
                        // q_cnt = menuItem.getAttribute('qn');
                    }
                });
            }

            $('#select-duration').change(function() {
                socket.emit('set-duration', $(this).val());
            });

            $('#select-level').change(function() {
                socket.emit('set-level', $(this).val());
            });

            $('#select-questions').change(function() {
                socket.emit('set-questions', $(this).val());
            });
        });

/*
        function make_task_list(tasks) {
            list = "<li><a href='#'>Mixed</a>";
            task_desc = tasks;
            for (var i = 0; i < tasks.length; i++)
                list += "<li task_id='" + i + "''><a href='#'>" + tasks[i].name + "</a></li>";
            $('#ll1').html(list);

            $("#ll1").lavaLamp({
                fx: "backout", 
                speed: 700,
                click: function(event, menuItem) {
                    id = menuItem.getAttribute('task_id');
                    task_kind = id;
                    if (id == null)
                        $('#task_description').html("Use random tasks");
                    else
                        $('#task_description').html(
                            task_desc[id].description.replace(/\n/g, '<br/>').replace(/http:\S+/g, '<a href="$&">$&</a>')
                        );
                    return false;
                }
            });
        }
*/
        </script>

        <script>
            socket = io.connect();
            socket.emit('get tasks description');
            socket.on('tasks description', showTasksSelection);

            socket.on('show task', showTask);

            socket.on('options', function(options) {
                $('#select-duration').val(options.duration);
                $('#select-level').val(options.level);
                $('#select-questions').val(options.questions);
            });

            socket.on('game loaded', function() {
                $('#newgame').attr('disabled', true);
                $('select').attr('disabled', true);
                $('#sound-waiting-for-game')[0].play();
                game_tasks = [];
                my_answers = [];
                $('#status').everyTime(1000, 'timer', function(it) {
                    $(this).html('Game starts in ' + (5-it));
                }, 5);
                $('#status').oneTime(4000, 'timer-sound', function() {
                    $('#sound-game-started')[0].play();
                });
                $('#status').oneTime(5050, 'timer2', function() {
                    socket.emit('get task', false);
                    game_duration = parseInt($('#select-duration').val());
                    game_playing = true;
                    $(this).html('Game ends in ' + game_duration);
                    $('#status').everyTime(1000, 'gametimer', function(it) {
                        $(this).html('Game ends in ' + (game_duration-it));
                    }, game_duration - 1);
                    $('#status').oneTime(game_duration * 1000, 'endtimer', function() {
                        $('#images').hide();
                        $(this).html('<h2>Game over!</h2>');
                        // $('#help').html('');
                        socket.emit('game over');
                        game_playing = false;
                        $('#newgame').attr('disabled', false);
                        $('select').attr('disabled', false);
                    });
                });
            });
 
            socket.on('announcement', function (msg) {
                $('#lines').append($('<p>').append($('<em>').text(msg)));
                $('#sound-enter')[0].play();
                $('#lines').get(0).scrollTop = 10000000;
            });

            socket.on('players', function(players) {
                $('#nicknames').empty().append($('<select><option>New room</option></select>'));
                for (var pl in players) {
                    total = players[pl].next_task - 1;
                    if (total < 0) total = 0;
                    text = pl;
                    if (players[pl].score != null) text = text + ": " + players[pl].score +
                        " (Q" + players[pl].next_task + ")";
                    tag = '<b>';
                    if (players[pl].ready) tag = '<i>';
                    $('#nicknames').append($(tag).text(text));
                } 
            });

            var changeTooltipPosition = function(event) {
                if (!event) event = window.event;
                var tooltipX = event.pageX - 8;
                var tooltipY = event.pageY + 8;
                $('div.tooltip').css({top: tooltipY, left: tooltipX});
            };
         
            var showTooltip = function(event) {
                num = event.target.id.substr(3);
                task = game_tasks[num];
                var url = 'http://geekbeta-nbeloglazov.dotcloud.com/image?id=' + task.id;
        
                html = '<img id="question" src="' + url + '&type=question"/> <br/>';
                for (var i = 0; i < 4; i++) {
                    style = 'style="border: #FFF 4px solid;"';
                    if (("" + i) === my_answers[num]) style = 'style="border: #F00 4px solid;"';
                    if (i === task.correct) style = 'style="border: #0F0 4px solid;"';
                    html += '<img class="answers" src="' + url + '&type=choice&number=' + i + '" ' + style + '/>';
                    if (i == 1) html += '<br/>';
                }
                $('div.tooltip').show().html(html);
                changeTooltipPosition();
            };
         
            var hideTooltip = function() {
                $('div.tooltip').hide();
            };

            socket.on('results', function(answers, players) {
                $('#box-table').css('visibility', 'visible');
                header = '<th>Nickname</th><th>Score</th><th>Solved</th><th>Answers</th>'
                table = '';
                list = [];
                for (var pl in players)
                    list.push({score: players[pl].score, nick: pl});
                list.sort(function(a, b) {return b.score - a.score});
                for (var i in list) {
                    pl = list[i].nick;
                    if (players[pl].score == null) return;
                    img = '';
                    $.each(answers[pl], function(index, value) {
                        box = "Box_Red";
                        if (value) box = "Box_Green";

                        new_img = '<img src="' + box + '.png">';
                        if (pl === $('#nick').val()) new_img = '<img src="' + box + '.png" id="ans' + index + '">';
                        img += new_img;
                    });
                    rclass = "other"
                    if (i == 0) rclass = "gold";
                    if (i == 1)
                        if (list[1].score != list[0].score) rclass = "silver";
                        else rclass = "gold";

                    if (i == 2) {
                        e01 = list[1].score == list[0].score;
                        e12 = list[2].score == list[1].score;
                        if (e01 && e12) rclass = "gold";
                        if (!e01 && e12) rclass = "silver";
                        if (!e12) rclass = "bronze";
                    }

                    row = '<tr class="' + rclass + '">' + '<td>' + pl + '</td><td>' +
                        players[pl].score + '</td><td>' +
                        players[pl].correct + ' of ' + (players[pl].next_task-1) + '</td><td>' +
                        img + '</td></tr>';

                    table += row;
                }
                $('#box-table').html('<table width="100%" align="center">' + header + table + '</table>');

                for (var i in list) {
                    if (list[i].nick != $('#nick').val()) continue;
                    $.each(answers[list[i].nick], function(index, value) {
                        $('#ans' + index)
                            .on('mousemove', changeTooltipPosition)
                            .on('mouseenter', showTooltip)
                            .on('mouseleave', hideTooltip);
                    });
                }
            });

            socket.on('user message', message);
            socket.on('reconnect', function () {
                  $('#lines').remove();
                  message('System', 'Reconnected to the server');
            });

            socket.on('reconnecting', function () {
                  message('System', 'Attempting to re-connect to the server');
            });

            socket.on('error', function (e) {
                  message('System', e ? e : 'A unknown error occurred');
            });

            socket.on('beep', function() {
                $('#sound-beep')[0].play();
            });

            function message (from, msg) {
                  $('#lines').append($('<p>').append($('<b>').text(from), msg));
                  $('#lines').get(0).scrollTop = 10000000;
                  if (from != 'System')
                      $('#sound-message-received')[0].play();
            }

        </script>
    </head>

    <body>
        <div id="splash">
            <p>Enter your nickname:</p>
            <form id="set-nickname">
                <input id="nick">
                <button>Ok</button>
            </form>
            <p id="nickname-err">This nickname is already used</p>
        </div>

        <div class="caption">
            Geek Battle
        </div>

        <table align="center" class="hide" id="main-table" width="800">
            <tr><td>
                <div class="back-divs" id="nicknames" text-align="left">
                    <select><option>New room</option></select>
                </div>
            </td></tr>

            <tr><td>
                <div class="back-divs" id="options" style="text-align: center;">
                    <table align="center">
                        <tr>
                            <td width="150">
                                Game type:
                            </td>
                            <td>
                                <select id='select-gametype'>
                                    <option value='time'>Time</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Game duration:
                            <td>
                                <!-- <ul class="lavaLampNoImage" id="ll-gamelength">
                                    <li length="15"><a href="#">15</a>
                                    <li length="30"><a href="#">30</a>
                                    <li length="60"><a href="#">60</a>
                                    <li length="120"><a href="#">120</a>
                                </ul> -->
                                <select id='select-duration'>
                                    <option value='15'>15</option>
                                    <option value='30'>30</option>
                                    <option value='60'>60</option>
                                    <option value='120'>120</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Questions:
                            <td>
                                <select id='select-questions'>
                                    <option value='mixed'>Mixed</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Level:
                            <td>
                                <!-- <ul class="lavaLampNoImage" id="ll-level">
                                    <li level="1"><a href="#">Easy</a></li>
                                    <li level="2"><a href="#">Medium</a></li>
                                    <li level="3"><a href="#">Hard</a></li>
                                </ul> -->
                                <select id='select-level'>
                                    <option value='1'>Easy</option>
                                    <option value='2'>Medium</option>
                                    <option value='3'>Hard</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </div>
            </td></tr>
            
            <tr><td align="center">
                <div class="back-divs" id="questions" style="min-height: 350px; background: #fff; text-align: center;">
                    <button id="newgame">New game</button>
                    <br/>
                    <span id="status">Press 'New game' to begin</span>
                    <br/>
                    <div id="images" class="hide">
                        <img id="question" class="answers"/>
                        <br/>
                        <img id="choice_0" class="answers"/>
                        <img id="choice_1" class="answers"/>
                        <br/>
                        <img id="choice_2" class="answers"/>
                        <img id="choice_3" class="answers"/>
                    </div>
                    <table id="box-table" align="center">
                            <tr><th>Results</th></tr>                            
                    </table>
                </div>
            </td></tr>

            <tr><td>
                <div class="back-divs" id="chat">
                    <div id="messages"><div id="lines" width="100%"></div></div>
                    <form id="send-message"><input id="message"><button>Send</button></form>
                </div>
            </td></tr>
        </table>
        Press Ctrl+R to choose a different nickname. Press Ctrl+W to log out.

        <audio preload="auto" id="sound-game-started">
            <source src="audio/Game started.mp3"></source>
            <source src="audio/Game started.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-message-sent">
            <source src="audio/Message sent.mp3"></source>
            <source src="audio/Message sent.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-message-received">
            <source src="audio/Message Received.mp3"></source>
            <source src="audio/Message Received.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-beep">
            <source src="audio/Beep.mp3"></source>
            <source src="audio/Beep.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-waiting-for-game">
            <source src="audio/Waiting for game.mp3"></source>
            <source src="audio/Waiting for game.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-enter">
            <source src="audio/Enter.mp3"></source>
            <source src="audio/Enter.ogg"></source>
        </audio>

        <div class="tooltip"></div>
    </body>
</html>

