<html>
    <head>
        <title>
            Task viewer
        </title>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="http://geek-battle.herokuapp.com/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="jquery.timers.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script type="text/javascript">

        function getTask() {
            var level = $(this).data('level');
            var taskType = $('#tasks').val();
            $.getJSON('task', {type: taskType, level: level}, showTask);
        }

        function showTask(task) {
            if (task == null) {
                $('#question').attr('src', 'http://260days.ca/wp-content/uploads/2011/03/done.gif');
                for (var i = 0; i < 4; i++)
                    $('#choice_' + i).addClass('hide');
                return;
            }

            // $('#help').html(help);
            $(document.body).removeClass('first');
            var url = 'http://geekbeta-nbeloglazov.dotcloud.com/image?id=' + task.id;
            $('#question').attr('src', url + '&type=question');
            $('.correct').removeClass('correct');
            $('.incorrect').removeClass('incorrect');
            for (var i = 0; i < 4; i++) {
                $('#choice_' + i).attr('src', url + '&type=choice&number=' + i);
                $('#choice_' + i).attr('correct', i === task.correct);
            }
            $('.hide').removeClass('hide');
        }

        function showTasksSelection(tasks) {
            var options = $('#tasks')[0].options;
            $.each(tasks, function() {
                var option = new Option(this.name, this.type);
                options[options.length] = option;
            });
        }

        $(function() {
            // $.getJSON('/tasks', showTasksSelection);
            for (var i = 0; i < 4; i++) {
                $('#choice_' + i).click(function() {
                    $(this).addClass($(this).attr('correct') == "true" ? 'correct' : 'incorrect');
                    socket.emit('get task', $(this).attr('correct') == "true");
                });
                // $('#choice_' + i).extend({res: false});
            }

            $('#newgame').on('click', function() {
                $('#status').html('Waiting for players...');
                socket.emit('new game');
            });

            $('#set-nickname').submit(function() {
                socket.emit('nickname', $('#nick').val());
                $('#splash').css('visibility', 'hidden');
                return false;
            });

            $('#send-message').submit(function() {
                message('me', $('#message').val());
                socket.emit('user message', $('#message').val());
                clear();
                return false;
            });

            function clear () {
                $('#message').val('').focus();
            };

            $('img').on('click', function() {
                $(this)
            });
        });

        </script>

        <script>
            socket = io.connect();
            socket.on('show task', showTask);
              
            socket.on('game loaded', function() {
                $('#status').everyTime(1000, 'timer', function(it) {
                    $(this).html('Game starts in ' + (5-it));
                }, 5);
                $('#status').oneTime(5050, 'timer2', function() {
                    socket.emit('get task', false);
                    game_duration = 45;
                    $(this).html('Game ends in ' + game_duration);
                    $('#status').everyTime(1000, 'gametimer', function(it) {
                        $(this).html('Game ends in ' + (game_duration-it));
                    }, game_duration - 1);
                    $('#status').oneTime(game_duration * 1000, 'endtimer', function() {
                        $('#question').attr('src', 'http://260days.ca/wp-content/uploads/2011/03/done.gif');
                        for (var i = 0; i < 4; i++)
                            $('#choice_' + i).addClass('hide');
                        $(this).html('Game over!');
                        // $('#help').html('');
                        socket.emit('game over');
                    });
                });
            });
 
            socket.on('announcement', function (msg) {
                $('#lines').append($('<p>').append($('<em>').text(msg)));
                $('#lines').get(0).scrollTop = 10000000;
            });

            socket.on('players', function(players) {
                $('#nicknames').empty().append($('<span>Online: </span><br>'));
                for (var pl in players) {
                    total = players[pl].next_task - 1;
                    if (total < 0) total = 0;
                    text = pl;
                    if (players[pl].score != null) text = text + ": " + players[pl].score + " of " + total;
                    tag = '<b>';
                    if (players[pl].ready) tag = '<i>';
                    $('#nicknames').append($(tag).text(text));
                    $('#nicknames').append($('<br>'));
                } 
            });

            socket.on('user message', message);
            socket.on('reconnect', function () {
                  $('#lines').remove();
                  message('System', 'Reconnected to the server');
            });

            socket.on('reconnecting', function () {
                  message('System', 'Attempting to re-connect to the server');
            });

            socket.on('error', function (e) {
                  message('System', e ? e : 'A unknown error occurred');
            });

            function message (from, msg) {
                  $('#lines').append($('<p>').append($('<b>').text(from), msg));
                  $('#lines').get(0).scrollTop = 10000000;
            }

        </script>

        <style type="text/css">
        body {
            text-align: center;
            padding-top: 20px;
        }
        img {
            padding: 10px;
            border: #FFF 4px solid;
        }
        
        .hide {
            display: none;
        }

        .first img {
            display: none;
        }

        .correct:hover {
            border: #0F0 solid 4px;
        }

        .incorrect:hover {
            border: #F00 solid 4px;
        }
        </style>

        <style>
            
        </style>
    </head>

    <body class="first">
        <div id="splash">
            <p>Enter your nickname:</p>
            <form id="set-nickname">
                <input id="nick">
                <button>Ok</button>
            </form>
            <p id="nickname-err">This nickname is already used</p>
        </div>
        <table cellpadding=10 height=600 width=800 align="center" border="1">
            <tr>
                <td width="120">
                    <div id="nicknames"></div>
                </td>
                <td align="center" valign="top">
                    <div>
                    <button id="newgame">New game</button>
                    </div>
                    <span id="status">Press 'New game' to begin</span>
                    <br>
                    <span id="help"></span>
                    <br>
                    <img id="question"></img>
                    <br/>
                    <img id="choice_0"></img>
                    <img id="choice_1"></img>
                    <br/>
                    <img id="choice_2"></img>
                    <img id="choice_3"></img>
                </td>
            </tr>
            <tr height="20%">
                <td colspan=2 valign="middle">
                    <div id="messages"><div id="lines" width="100%"></div></div>
                    <form id="send-message"><input id="message"><button>Send</button></form>
                </td>
            </tr>
        </table>
    </body>
</html>

