<html>
    <head>
        <title>
            Task viewer
        </title>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="jquery-ui-1.7.2.custom.min.js"></script>
        <script src="http://geek-battle.herokuapp.com/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="jquery.timers.js"></script>
        <script type="text/javascript" src="jquery.flip.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script type="text/javascript">

        function showTask(task) {
            if (task == null) {
                $('.answers').addClass('hide');
                return;
            }

            // $('#help').html(help);
            $(document.body).removeClass('first');
            var url = 'http://geekalarm-nbeloglazov.rhcloud.com/image?id=' + task.id;
            $('#question').attr('src', url + '&type=question');
            $('.correct').removeClass('correct');
            $('.incorrect').removeClass('incorrect');
            for (var i = 0; i < 4; i++) {
                $('#choice_' + i).attr('src', url + '&type=choice&number=' + i);
                $('#choice_' + i).attr('correct', i === task.correct);
            }
            $('.hide').removeClass('hide');
        }

        function showTasksSelection(tasks) {
            var options = $('#tasks')[0].options;
            $.each(tasks, function() {
                var option = new Option(this.name, this.type);
                options[options.length] = option;
            });
        }

        $(function() {
            for (var i = 0; i < 4; i++) {
                $('#choice_' + i).click(function() {
                    $(this).addClass($(this).attr('correct') == "true" ? 'correct' : 'incorrect');
                    socket.emit('get task', $(this).attr('correct') == "true");
                    $('.answers').addClass('hide');
                    $('#images').css('background-color', $(this).attr('correct') == "true" ? '#00ff00' : '#ff0000');
                    $('#images').flip({
                        direction: 'rl',
                        speed: 300,
                        color: '#ffffff'
                    });
                });
            }

            $('#newgame').on('click', function() {
                $('#status').html('Waiting for players...');
                $('#box-table').css('visibility', 'hidden');
                socket.emit('new game');
            });

            $('#set-nickname').submit(function() {
                if ($.trim($('#nick').val()) == "") return false;
                socket.emit('nickname', $('#nick').val());
                $('#splash').css('visibility', 'hidden');
                // $('#sound-enter')[0].play();
                return false;
            });

            $('#send-message').submit(function() {
                var msg = $.trim($('#message').val());
                if (msg == "") return false;
                message('me', msg);
                socket.emit('user message', msg);
                // $('#sound-message-sent')[0].play();
                clear();
                return false;
            });

            function clear () {
                $('#message').val('').focus();
            };
        });

        </script>

        <script>
            socket = io.connect();
            socket.on('show task', showTask);
              
            socket.on('game loaded', function() {
                $('#sound-waiting-for-game')[0].play();
                $('#status').everyTime(1000, 'timer', function(it) {
                    $(this).html('Game starts in ' + (5-it));
                }, 5);
                $('#status').oneTime(4000, 'timer-sound', function() {
                    $('#sound-game-started')[0].play();
                });
                $('#status').oneTime(5050, 'timer2', function() {
                    socket.emit('get task', false);
                    game_duration = 60;
                    $(this).html('Game ends in ' + game_duration);
                    $('#status').everyTime(1000, 'gametimer', function(it) {
                        $(this).html('Game ends in ' + (game_duration-it));
                    }, game_duration - 1);
                    $('#status').oneTime(game_duration * 1000, 'endtimer', function() {
                        $('.answers').addClass('hide');
                        $(this).html('<h2>Game over!</h2>');
                        // $('#help').html('');
                        socket.emit('game over');
                    });
                });
            });
 
            socket.on('announcement', function (msg) {
                $('#lines').append($('<p>').append($('<em>').text(msg)));
                $('#sound-enter')[0].play();
                $('#lines').get(0).scrollTop = 10000000;
            });

            socket.on('players', function(players) {
                $('#nicknames').empty().append($('<span>Online: </span><br>'));
                for (var pl in players) {
                    total = players[pl].next_task - 1;
                    if (total < 0) total = 0;
                    text = pl;
                    if (players[pl].score != null) text = text + ": " + players[pl].score +
                        " (Q" + players[pl].next_task + ")";
                    tag = '<b>';
                    if (players[pl].ready) tag = '<i>';
                    $('#nicknames').append($(tag).text(text));
                    $('#nicknames').append($('<br>'));
                } 
            });

            socket.on('results', function(answers, players) {
                $('#box-table').css('visibility', 'visible');
                header = '<th>Nickname</th><th>Score</th><th>Solved</th><th>Answers</th>'
                table = '';
                list = [];
                for (var pl in players)
                    list.push({score: players[pl].score, nick: pl});
                list.sort(function(a, b) {return b.score - a.score});
                for (var i in list) {
                    pl = list[i].nick;
                    if (players[pl].score == null) return;
                    img = '';
                    $.each(answers[pl], function(index, value) { 
                        if (value) img += '<img src="Box_Green.png">';
                        else img += '<img src="Box_Red.png">';
                    });
                    rclass = "other"
                    if (i == 0) rclass = "gold";
                    if (i == 1)
                        if (list[1].score != list[0].score) rclass = "silver";
                        else rclass = "gold";

                    if (i == 2) {
                        e01 = list[1].score == list[0].score;
                        e12 = list[2].score == list[1].score;
                        if (e01 && e12) rclass = "gold";
                        if (!e01 && e12) rclass = "silver";
                        if (!e12) rclass = "bronze";
                    }

                    row = '<tr class="' + rclass + '">' + '<td>' + pl + '</td><td>' +
                        players[pl].score + '</td><td>' +
                        players[pl].correct + ' of ' + (players[pl].next_task-1) + '</td><td>' +
                        img + '</td></tr>';

                    table += row;
                }
                $('#box-table').html('<table>' + header + table + '</table>');
            });

            socket.on('user message', message);
            socket.on('reconnect', function () {
                  $('#lines').remove();
                  message('System', 'Reconnected to the server');
            });

            socket.on('reconnecting', function () {
                  message('System', 'Attempting to re-connect to the server');
            });

            socket.on('error', function (e) {
                  message('System', e ? e : 'A unknown error occurred');
            });

            socket.on('beep', function() {
                $('#sound-beep')[0].play();
            });

            function message (from, msg) {
                  $('#lines').append($('<p>').append($('<b>').text(from), msg));
                  $('#lines').get(0).scrollTop = 10000000;
                  if (from != 'System')
                      $('#sound-message-received')[0].play();
            }

        </script>

        <style type="text/css">
        body {
            text-align: center;
            padding-top: 20px;
        }
        .answers {
            padding: 10px;
            border: #FFF 4px solid;
        }
        .answers:hover {
            border: #AAA solid 4px;
        }
        
        .hide {
            display: none;
        }

        .first img {
            display: none;
        }

        .green {
            background-color: #00ff00;
        }
        </style>
    </head>

    <body class="first">
        <div id="splash">
            <p>Enter your nickname:</p>
            <form id="set-nickname">
                <input id="nick">
                <button>Ok</button>
            </form>
            <p id="nickname-err">This nickname is already used</p>
        </div>
        <div class="caption">
            Geek Battle
        </div>
        <table cellpadding=10 height=600 width=800 align="center" border="1">
            <tr>
                <td width="120">
                    <div id="nicknames"></div>
                </td>
                <td align="center" valign="top">
                    <div>
                    <button id="newgame">New game</button>
                    </div>
                    <span id="status">Press 'New game' to begin</span>
                    <br/>
                    <div id="images">
                        <img id="question" class="answers"></img>
                        <br/>
                        <img id="choice_0" class="answers"></img>
                        <img id="choice_1" class="answers"></img>
                        <br/>
                        <img id="choice_2" class="answers"></img>
                        <img id="choice_3" class="answers"></img>
                        <table id="box-table">
                            <tr><th>Results</th></tr>                            
                        </table>
                    </div>
                </td>
            </tr>
            <tr height="20%">
                <td colspan=2 valign="middle">
                    <div id="messages"><div id="lines" width="100%"></div></div>
                    <form id="send-message"><input id="message"><button>Send</button></form>
                </td>
            </tr>
        </table>
        Press Ctrl+R to choose a different nickname. Press Ctrl+W to log out.<br>
        <audio preload="auto" id="sound-game-started">
            <source src="audio/Game started.mp3"></source>
            <source src="audio/Game started.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-message-sent">
            <source src="audio/Message sent.mp3"></source>
            <source src="audio/Message sent.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-message-received">
            <source src="audio/Message Received.mp3"></source>
            <source src="audio/Message Received.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-beep">
            <source src="audio/Beep.mp3"></source>
            <source src="audio/Beep.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-waiting-for-game">
            <source src="audio/Waiting for game.mp3"></source>
            <source src="audio/Waiting for game.ogg"></source>
        </audio>
        <audio preload="auto" id="sound-enter">
            <source src="audio/Enter.mp3"></source>
            <source src="audio/Enter.ogg"></source>
        </audio>
    </body>
</html>