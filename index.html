<html>
    <head>
        <title>
            Task viewer
        </title>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="http://hidden-wildwood-8127.herokuapp.com/socket.io/socket.io.js"></script>
        <script type="text/javascript">

        function getTask() {
            var level = $(this).data('level');
            var taskType = $('#tasks').val();
            $.getJSON('task', {type: taskType, level: level}, showTask);
        }

        function showTask(task) {
            if (task == null) {
                $('#question').attr('src', 'http://260days.ca/wp-content/uploads/2011/03/done.gif');
                for (var i = 0; i < 4; i++)
                    $('#choice_' + i).addClass('hide');
                return;
            }

            $(document.body).removeClass('first');
            var url = 'http://geekbeta-nbeloglazov.dotcloud.com/image?id=' + task.id;
            $('#question').attr('src', url + '&type=question');
            $('.correct').removeClass('correct');
            $('.incorrect').removeClass('incorrect');
            for (var i = 0; i < 4; i++) {
                $('#choice_' + i).attr('src', url + '&type=choice&number=' + i);
                $('#choice_' + i).addClass(i === task.correct ? 'correct' : 'incorrect');
            }
            $('.hide').removeClass('hide');
        }

        function showTasksSelection(tasks) {
            var options = $('#tasks')[0].options;
            $.each(tasks, function() {
                var option = new Option(this.name, this.type);
                options[options.length] = option;
            });
        }

        $(function() {
            // $.getJSON('/tasks', showTasksSelection);
            $('#next').on('click', function() {
                socket.emit('get task');
            });
            $('#newgame').on('click', function() {
                $('#status').html('Loading...');
                socket.emit('new game');
            });

            $('#set-nickname').submit(function (ev) {
                socket.emit('nickname', $('#nick').val(), function (set) {
                    if (!set) {
                        clear();
                        return $('#chat').addClass('nickname-set');
                    }
                    $('#nickname-err').css('visibility', 'visible');
                });
                return false;
            });

            $('#send-message').submit(function () {
                message('me', $('#message').val());
                socket.emit('user message', $('#message').val());
                clear();
                $('#lines').get(0).scrollTop = 10000000;
                return false;
            });

            function clear () {
                $('#message').val('').focus();
            };
        });

        </script>

        <script>
            socket = io.connect();
            socket.on('show task', showTask);
              
            socket.on('game loaded', function() {
                $('#status').html('Loaded.');
            });
 
            socket.on('announcement', function (msg) {
                $('#lines').append($('<p>').append($('<em>').text(msg)));
            });

            socket.on('nicknames', function (nicknames) {
                $('#nicknames').empty().append($('<span>Online: </span><br>'));
                for (var i in nicknames) {
                    $('#nicknames').append($('<b>').text(nicknames[i]));
                    $('#nicknames').append($('<br>'));
                }
            });

            socket.on('user message', message);
            socket.on('reconnect', function () {
                  $('#lines').remove();
                  message('System', 'Reconnected to the server');
            });

            socket.on('reconnecting', function () {
                  message('System', 'Attempting to re-connect to the server');
            });

            socket.on('error', function (e) {
                  message('System', e ? e : 'A unknown error occurred');
            });

            function message (from, msg) {
                  $('#lines').append($('<p>').append($('<b>').text(from), msg));
            }

        </script>

        <style type="text/css">
        body {
            text-align: center;
            padding-top: 20px;
        }
        img {
            padding: 10px;
            border: #FFF 4px solid;
        }
        
        .hide {
            display: none;
        }

        .first img {
            display: none;
        }

        .correct:hover {
            border: #0F0 solid 4px;
        }

        .incorrect:hover {
            border: #F00 solid 4px;
        }
        </style>

        <style>
            #messages {
                height: 130px;
                background: #eee;
            }
            #messages em {
                text-shadow: 0 1px 0 #fff;
                color: #999;
            }
            #messages p {
                padding: 0;
                margin: 0;
                font: 12px Helvetica, Arial;
                padding: 5px 10px;
            }
            #messages p b {
                display: inline-block;
                padding-right: 10px;
            }
            #messages p:nth-child(even) {
                background: #fafafa;
            }
            #nicknames {
                width: 100%;
                height: 100%;
                background: #eee;
                padding: 2px 4px 4px;
                font: 14px Helvetica;
            }
            #nicknames span {
                color: #000;
            }
            #nicknames b {
                display: inline-block;
                color: #fff;
                background: #999;
                padding: 3px 6px;
                margin-top: 5px;
                -webkit-border-radius: 10px;
                -moz-border-radius: 10px;
                border-radius: 10px;
                text-shadow: 0 1px 0 #666;
            }
            #messages #lines {
                height: 130px;
                overflow: auto;
                overflow-x: hidden;
                overflow-y: auto;
            }
            #messages #lines::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            #messages #lines::-webkit-scrollbar-button:start:decrement,
            #messages #lines ::-webkit-scrollbar-button:end:increment {
                display: block;
                height: 10px;
            }
            #messages #lines::-webkit-scrollbar-button:vertical:increment {
                background-color: #fff;
            }
            #messages #lines::-webkit-scrollbar-track-piece {
                background-color: #fff;
                -webkit-border-radius: 3px;
            }
            #messages #lines::-webkit-scrollbar-thumb:vertical {
                height: 50px;
                background-color: #ccc;
                -webkit-border-radius: 3px;
            }
            #messages #lines::-webkit-scrollbar-thumb:horizontal {
                width: 50px;
                background-color: #fff;
                -webkit-border-radius: 3px;
            }
            #send-message {
                background: #fff;
                position: relative;
            }
            #send-message input {
                height: 30px;
                padding: 0 10px;
                line-height: 30px;
                vertical-align: middle;
                width: 710px;
            }
            #send-message input:focus {
                outline: 0;
            }
            #send-message button {
                position: absolute;
                top: 5px;
                right: 5px;
            }
            button {
                margin: 0;
                -webkit-user-select: none;
                -moz-user-select: none;
                user-select: none;
                display: inline-block;
                text-decoration: none;
                background: #43a1f7;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0, #43a1f7), color-stop(1, #377ad0));
                background: -webkit-linear-gradient(top, #43a1f7 0%, #377ad0 100%);
                background: -moz-linear-gradient(top, #43a1f7 0%, #377ad0 100%);
                background: linear-gradient(top, #43a1f7 0%, #377ad0 100%);
                border: 1px solid #2e70c4;
                -webkit-border-radius: 16px;
                -moz-border-radius: 16px;
                border-radius: 16px;
                color: #fff;
                font-family: "lucida grande", sans-serif;
                font-size: 11px;
                font-weight: normal;
                line-height: 1;
                padding: 3px 10px 5px 10px;
                text-align: center;
                text-shadow: 0 -1px 1px #2d6dc0;
            }
            button:hover,
            button.hover {
                background: darker;
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0, #43a1f7), color-stop(1, #2e70c4));
                background: -webkit-linear-gradient(top, #43a1f7 0%, #2e70c4 100%);
                background: -moz-linear-gradient(top, #43a1f7 0%, #2e70c4 100%);
                background: linear-gradient(top, #43a1f7 0%, #2e70c4 100%);
                border: 1px solid #2e70c4;
                cursor: pointer;
                text-shadow: 0 -1px 1px #2c6bbb;
            }
            button:active,
            button.active {
                background: #2e70c4;
                border: 1px solid #2e70c4;
                border-bottom: 1px solid #2861aa;
                text-shadow: 0 -1px 1px #2b67b5;
            }
            button:focus,
            button.focus {
                outline: none;
                -webkit-box-shadow: 0 1px 0 0 rgba(255,255,255,0.40), 0 0 4px 0 #377ad0;
                -moz-box-shadow: 0 1px 0 0 rgba(255,255,255,0.40), 0 0 4px 0 #377ad0;
                box-shadow: 0 1px 0 0 rgba(255,255,255,0.40), 0 0 4px 0 #377ad0;
            }
        </style>
    </head>

    <body class="first">
        <table cellpadding=10 height=600 width=800 align="center" border="1">
            <tr>
                <td width="120">
                    <div id="nicknames"></div>
                </td>
                <td align="center" valign="top">
                    <div>
                    <button id="newgame">New game</button>
                    <button id="next">Next</button>
                    </div>
                    <span id="status">Status</span>
                    <br>
                    <img id="question"></img>
                    <br/>
                    <img id="choice_0"></img>
                    <img id="choice_1"></img>
                    <br/>
                    <img id="choice_2"></img>
                    <img id="choice_3"></img>
                </td>
            </tr>
            <tr height="20%">
                <td colspan=2 valign="middle">
                    <div id="messages"><div id="lines" width="100%"></div></div>
                    <form id="send-message"><input id="message"><button>Send</button></form>
                </td>
            </tr>
        </table>
    </body>
</html>

